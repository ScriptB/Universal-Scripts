local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RS = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local plr = Players.LocalPlayer
local char = plr.Character or plr.CharacterAdded:Wait()
local rootPart = char:WaitForChild("HumanoidRootPart")

local STATE = {
    flying = false,
    noclip = false,
    antiSit = false,
    speed = 10,
}

local dirs = {
    fwd = 0, bwd = 0,
    left = 0, right = 0,
    down = 0, up = 0
}

local lastDirs = {
    fwd = 0, bwd = 0,
    left = 0, right = 0,
    down = 0, up = 0
}

local connections = {
    noclip = nil,
    antiSit = {}
}

local function initFly()
    STATE.flying = true
    local gyro = Instance.new("BodyGyro")
    local velo = Instance.new("BodyVelocity")
    
    gyro.P = 9e4
    gyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
    gyro.CFrame = workspace.CurrentCamera.CFrame
    gyro.Parent = rootPart
    
    velo.Velocity = Vector3.zero
    velo.MaxForce = Vector3.new(9e9, 9e9, 9e9)
    velo.Parent = rootPart
    
    task.spawn(function()
        while STATE.flying do
            task.wait()
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum then hum.PlatformStand = true end
            
            if (dirs.left + dirs.right) ~= 0 or (dirs.fwd + dirs.bwd) ~= 0 or (dirs.down + dirs.up) ~= 0 then
                lastDirs = {
                    fwd = dirs.fwd, bwd = dirs.bwd,
                    left = dirs.left, right = dirs.right,
                    down = dirs.down, up = dirs.up
                }
            end
            
            local cam = workspace.CurrentCamera
            local fwdVec = cam.CFrame.LookVector * (dirs.fwd + dirs.bwd)
            local rightVec = cam.CFrame.RightVector * (dirs.left + dirs.right)
            local upVec = Vector3.new(0, -(dirs.down + dirs.up), 0)
            
            local isMoving = (dirs.left + dirs.right) ~= 0 or 
                           (dirs.fwd + dirs.bwd) ~= 0 or 
                           (dirs.down + dirs.up) ~= 0
            
            velo.Velocity = (fwdVec + rightVec + upVec) * (isMoving and STATE.speed or 0)
            gyro.CFrame = cam.CFrame
        end
        
        dirs = {fwd = 0, bwd = 0, left = 0, right = 0, down = 0, up = 0}
        lastDirs = {fwd = 0, bwd = 0, left = 0, right = 0, down = 0, up = 0}
        gyro:Destroy()
        velo:Destroy()
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then hum.PlatformStand = false end
    end)
end

local function toggleNoclip()
    STATE.noclip = not STATE.noclip

    if STATE.noclip then
        connections.noclip = RS.Stepped:Connect(function()
            pcall(function()
                for _, part in pairs(plr.Character:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = false
                    end
                end
            end)
        end)
    else
        if connections.noclip then
            connections.noclip:Disconnect()
            connections.noclip = nil
        end
        pcall(function()
            for _, part in pairs(plr.Character:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = true
                end
            end
        end)
    end
end

local function neutralizeSeat(seat)
    if seat:IsA("Seat") or seat:IsA("VehicleSeat") then
        seat.Disabled = true
        seat.CanTouch = false
        seat:SetAttribute("Neutralized", true)
    end
end

local function toggleAntiSit()
    STATE.antiSit = not STATE.antiSit

    if STATE.antiSit then
        for _, obj in ipairs(Workspace:GetDescendants()) do
            neutralizeSeat(obj)
        end

        connections.antiSit.descendant = Workspace.DescendantAdded:Connect(function(obj)
            if STATE.antiSit and (obj:IsA("Seat") or obj:IsA("VehicleSeat")) then
                task.wait(0.1)
                neutralizeSeat(obj)
            end
        end)

        connections.antiSit.character = plr.CharacterAdded:Connect(function(newChar)
            if STATE.antiSit then
                local humanoid = newChar:WaitForChild("Humanoid")
                connections.antiSit.sit = humanoid:GetPropertyChangedSignal("Sit"):Connect(function()
                    if STATE.antiSit and humanoid.Sit then
                        humanoid.Sit = false
                    end
                end)
            end
        end)

        if char then
            local humanoid = char:FindFirstChildOfClass("Humanoid")
            if humanoid then
                connections.antiSit.sit = humanoid:GetPropertyChangedSignal("Sit"):Connect(function()
                    if STATE.antiSit and humanoid.Sit then
                        humanoid.Sit = false
                    end
                end)
            end
        end
    else
        for _, conn in pairs(connections.antiSit) do
            if conn then conn:Disconnect() end
        end
        connections.antiSit = {}

        for _, obj in ipairs(Workspace:GetDescendants()) do
            if (obj:IsA("Seat") or obj:IsA("VehicleSeat")) and obj:GetAttribute("Neutralized") then
                obj.Disabled = false
                obj.CanTouch = true
                obj:SetAttribute("Neutralized", nil)
            end
        end
    end
end

local function setupInputHandlers()
    UIS.InputBegan:Connect(function(inp, proc)
        if proc then return end
        local kc = inp.KeyCode
        
        if kc == Enum.KeyCode.W then dirs.fwd = 1
        elseif kc == Enum.KeyCode.S then dirs.bwd = -1
        elseif kc == Enum.KeyCode.A then dirs.left = -1
        elseif kc == Enum.KeyCode.D then dirs.right = 1
        elseif kc == Enum.KeyCode.Q then dirs.down = 1
        elseif kc == Enum.KeyCode.E then dirs.up = -1
        end
    end)
    
    UIS.InputEnded:Connect(function(inp, proc)
        if proc then return end
        local kc = inp.KeyCode
        
        if kc == Enum.KeyCode.W then dirs.fwd = 0
        elseif kc == Enum.KeyCode.S then dirs.bwd = 0
        elseif kc == Enum.KeyCode.A then dirs.left = 0
        elseif kc == Enum.KeyCode.D then dirs.right = 0
        elseif kc == Enum.KeyCode.Q then dirs.down = 0
        elseif kc == Enum.KeyCode.E then dirs.up = 0
        end
    end)
end

setupInputHandlers()